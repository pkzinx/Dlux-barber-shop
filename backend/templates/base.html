<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Painel Dlux{% endblock %}</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="{% static 'panel.css' %}" rel="stylesheet">
    <style>
      :root{
        --dlux-bg:#0f0f10; --dlux-card:#18181a; --dlux-accent:#c59d5f; --dlux-text:#eaeaea; --dlux-muted:#a3a3a3;
        --success:#22c55e; --danger:#ef4444; --warning:#f59e0b;
      }
      body{ background:var(--dlux-bg); color:var(--dlux-text); }
      .navbar-dark.bg-dark{ background-color:#121212 !important; }
      .card-panel{ background:var(--dlux-card); border:1px solid #232325; color:var(--dlux-text); }
      .card-panel .card-header{ border-bottom:1px solid #232325; }
      .kpi{ font-weight:700; font-size:1.6rem; }
      .kpi-label{ color:var(--dlux-muted); font-size:.85rem; }
      .table-dark.table{ --bs-table-bg:#151516; --bs-table-striped-bg:#1a1a1c; --bs-table-border-color:#2a2a2d; }
      .badge-accent{ background-color:var(--dlux-accent); }
      .text-accent{ color:var(--dlux-accent) !important; }
      .btn-accent{ background:var(--dlux-accent); color:#111; border:none; }
      .btn-accent:hover{ filter:brightness(1.1); }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
      <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="/painel/">
          <img src="/static/assets/img/icon-logo.png" alt="Dlux" class="me-2" style="height:24px;width:auto;max-height:24px;display:inline-block;" />
          <span class="fw-semibold">Dlux Painel</span>
        </a>
        <div class="d-flex align-items-center gap-2">
          {% if user.is_authenticated %}
            <span class="navbar-text me-3 small d-flex align-items-center gap-2">
              {% if user.avatar %}
                <img src="{{ user.avatar.url }}" alt="avatar" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;">
              {% else %}
                {% with name=user.display_name|default:user.username %}
                  {% if name|lower == 'kaue' %}
                    <img src="/static/assets/img/kaue.jpg" alt="Kaue" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;">
                  {% elif name|lower == 'alafy' %}
                    <img src="/static/assets/img/alafy.JPEG" alt="Alafy" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;">
                  {% elif name|lower == 'kevin' %}
                    <img src="/static/assets/img/kevin.JPEG" alt="Kevin" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;">
                  {% elif name|lower == 'rikelv' %}
                    <img src="/static/assets/img/rikelv.JPEG" alt="Rikelv" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;">
                  {% elif name|lower == 'emerson' %}
                    <img src="/static/assets/img/emerson.JPG" alt="Emerson" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;">
                  {% else %}
                    <img src="/static/assets/img/icon-logo.png" alt="User" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;">
                  {% endif %}
                {% endwith %}
              {% endif %}
              <span>{{ user.display_name|default:user.username }}</span>
            </span>
            <form method="post" action="/logout/" class="d-inline">
              {% csrf_token %}
              <button class="btn btn-outline-light btn-sm" type="submit">Sair</button>
            </form>
          {% else %}
            <a class="btn btn-outline-light btn-sm" href="/login/">Entrar</a>
          {% endif %}
        </div>
      </div>
    </nav>
    <div class="container-fluid">
      <div class="row flex-nowrap">
        {% if user.is_authenticated %}
        <aside class="col-12 col-lg-2 sidebar p-0 collapse d-lg-block" id="sidebar">
          <div class="list-group list-group-flush">
            <a class="list-group-item list-group-item-action px-3 sidebar-link {% if request.path == '/painel/' %}active{% endif %}" href="/painel/">
              <span class="me-2" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 3l9 8h-3v8h-12v-8h-3l9-8z"></path></svg>
              </span>
              Início
            </a>
            <a class="list-group-item list-group-item-action px-3 sidebar-link {% if '/painel/agendamentos' in request.path %}active{% endif %}" href="/painel/agendamentos/">
              <span class="me-2" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M7 10h5v5H7zM3 4h2V2h2v2h8V2h2v2h2c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H3c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2zM3 20h18V9H3v11z"></path></svg>
              </span>
              Agendamentos
            </a>
            <a class="list-group-item list-group-item-action px-3 sidebar-link {% if '/painel/financas' in request.path %}active{% endif %}" href="/painel/financas/">
              <span class="me-2" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 1L3 5v6c0 5 3.8 9.7 9 11 5.2-1.3 9-6 9-11V5l-9-4zM11 6h2v2h-2V6zm0 4h2v6h-2v-6z"></path></svg>
              </span>
              Finanças
            </a>
            <a class="list-group-item list-group-item-action px-3 sidebar-link {% if '/painel/clientes' in request.path %}active{% endif %}" href="/painel/clientes/">
              <span class="me-2" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M16 11c1.7 0 3-1.3 3-3s-1.3-3-3-3-3 1.3-3 3 1.3 3 3 3zm-8 0c1.7 0 3-1.3 3-3S9.7 5 8 5 5 6.3 5 8s1.3 3 3 3zm0 2c-2.7 0-8 1.4-8 4v2h10v-2c0-2.6-5.3-4-8-4zm8 0c-.3 0-.6 0-.9.1 1.5.8 2.9 2.1 2.9 3.9v2h8v-2c0-2.6-5.3-4-8-4z"></path></svg>
              </span>
              Clientes
            </a>
            {% if user.is_superuser or user.username|lower == 'kaue' or user.username|lower == 'alafy' %}
            <a class="list-group-item list-group-item-action px-3 sidebar-link {% if '/painel/servicos' in request.path %}active{% endif %}" href="/painel/servicos/">
              <span class="me-2" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" aria-hidden="true">
                  <path d="M3 5.5c0-1.1.9-2 2-2 1.2 0 2.3.6 3 1.5l3 4.1 3-4.1c.7-.9 1.8-1.5 3-1.5 1.1 0 2 .9 2 2 0 .5-.2 1-.6 1.4l-4.1 4.1 1.6 2.1c.1.1.1.3.1.4 0 .4-.3.8-.8.8-.2 0-.4-.1-.5-.3L13 12.4l-1.8 2.5c-.1.2-.3.3-.5.3-.5 0-.8-.4-.8-.8 0-.1 0-.3.1-.4l1.6-2.1-4.1-4.1C5.2 6.5 5 6 5 5.5Z"></path>
                  <path d="M6 14c1.1 0 2 .9 2 2 0 1.2-.6 2.3-1.5 3-.2.2-.4.5-.5.7-.1.2-.4.3-.6.3s-.5-.1-.6-.3c-.1-.2-.3-.5-.5-.7C3.6 18.3 3 17.2 3 16c0-1.1.9-2 2-2Zm12 0c1.1 0 2 .9 2 2 0 1.2-.6 2.3-1.5 3-.2.2-.4.5-.5.7-.1.2-.4.3-.6.3s-.5-.1-.6-.3c-.1-.2-.3-.5-.5-.7-.9-.7-1.5-1.8-1.5-3 0-1.1.9-2 2-2Z"></path>
                </svg>
              </span>
              Serviços
            </a>
            {% endif %}
            {% if user.username|lower == 'kaue' or user.username|lower == 'alafy' %}
            <a class="list-group-item list-group-item-action px-3 sidebar-link {% if '/painel/historico' in request.path %}active{% endif %}" href="/painel/historico/">
              <span class="me-2" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M13 3a9 9 0 1 0 8.95 8H20a7 7 0 1 1-7-7V3zM12 7v6l5 3 .75-1.23-4.25-2.77V7z"></path></svg>
              </span>
              Histórico
            </a>
            {% endif %}
            <a class="list-group-item list-group-item-action px-3 sidebar-link {% if '/painel/perfil' in request.path %}active{% endif %}" href="/painel/perfil/">
              <span class="me-2" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M12 12c2.7 0 4.8-2.2 4.8-4.8S14.7 2.4 12 2.4 7.2 4.6 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8V22h19.2v-2.8c0-3.2-6.4-4.8-9.6-4.8z"></path></svg>
              </span>
              Perfil
            </a>
          </div>
        </aside>
        {% endif %}
        <main class="{% if user.is_authenticated %}col py-4 px-3{% else %}col-12 py-4 px-3{% endif %}">
          <div aria-live="polite" aria-atomic="true" class="position-relative">
            <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
              {% if messages %}
                {% for message in messages %}
                  <div class="toast align-items-center text-bg-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} border-0 show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
                    <div class="d-flex">
                      <div class="toast-body">
                        {% if message.tags == 'success' %}<i class="bi bi-check-circle-fill me-2"></i>{% endif %}
                        {% if message.tags == 'error' or message.tags == 'warning' %}<i class="bi bi-exclamation-triangle-fill me-2"></i>{% endif %}
                        {{ message }}
                      </div>
                      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                  </div>
                {% endfor %}
              {% endif %}
            </div>
          </div>
          {% block content %}{% endblock %}
        </main>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/imask"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
      const btn = document.getElementById('toggleSidebar');
      const sidebar = document.getElementById('sidebar');
      if (btn && sidebar) { btn.addEventListener('click', () => { sidebar.classList.toggle('show'); }); }
    </script>
    
    <!-- Modal rápido de agendamento -->
    <div class="modal fade" id="quickScheduleModal" tabindex="-1" aria-labelledby="quickScheduleLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header">
            <h5 class="modal-title" id="quickScheduleLabel">Novo agendamento</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="quickScheduleForm">
              {% if user.role == 'admin' %}
              <div class="mb-3">
                <label class="form-label">Barbeiro</label>
                <select class="form-select" name="barber_id" id="qsBarber" required>
                  <option value="" disabled selected>Selecione...</option>
                </select>
              </div>
              {% else %}
              <input type="hidden" name="barber_id" value="{{ user.id }}">
              {% endif %}
              <div class="mb-3">
                <label class="form-label">Serviço</label>
                <select class="form-select" name="service_id" id="qsService" required></select>
              </div>
              <div class="row g-2 mb-3">
                <div class="col-6">
                  <label class="form-label">Data</label>
                  <input type="date" class="form-control" name="date" required>
                </div>
                <div class="col-6">
                  <label class="form-label">Hora</label>
                  <input type="time" class="form-control" name="time" id="qsTime" required>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Cliente</label>
                <input type="text" class="form-control" name="client_name" placeholder="Nome do cliente" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Telefone</label>
                <input type="text" class="form-control" name="client_phone" placeholder="11999999999" required>
              </div>
              <!-- Observações removidas conforme solicitação -->
              <button type="submit" class="btn btn-accent">Agendar</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Carregar serviços (autenticado) para popular select
      (function loadServices(){
        const sel = document.getElementById('qsService');
        if (!sel) return;
        fetch('/api/services/')
          .then(r => r.json())
          .then(data => {
            const results = Array.isArray(data) ? data : (data.results || []);
            sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
            results.forEach(s => {
              const opt = document.createElement('option');
              opt.value = s.id;
              opt.textContent = s.title + ' (' + (s.duration_minutes || 0) + ' min)';
              opt.dataset.duration = s.duration_minutes || 0;
              sel.appendChild(opt);
            });
          }).catch(() => {
            sel.innerHTML = '<option disabled>Falha ao carregar serviços</option>';
          });
      })();

      // Carregar barbeiros (apenas para admin)
      (function loadBarbers(){
        const sel = document.getElementById('qsBarber');
        if (!sel) return; // só existe para admin
        fetch('/api/appointments/barbers/')
          .then(r => r.json())
          .then(data => {
            const list = Array.isArray(data?.barbers) ? data.barbers : [];
            sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
            list.forEach(b => {
              const opt = document.createElement('option');
              opt.value = b.id;
              opt.textContent = b.name;
              sel.appendChild(opt);
            });
          })
          .catch(() => {
            sel.innerHTML = '<option disabled>Falha ao carregar barbeiros</option>';
          });
      })();

      // Submeter agendamento público com cálculo de end_datetime + toast bonito
      (function bindQuickSchedule(){
        const form = document.getElementById('quickScheduleForm');
        if (!form) return;

        function getCsrfToken(){
          const match = document.cookie.match(/csrftoken=([^;]+)/);
          return match ? match[1] : '';
        }

        // Carregar horários disponíveis conforme serviço e data selecionados
        const serviceSel = document.getElementById('qsService');
        const dateInput = form.querySelector('input[name="date"]');
        const timeInput = document.getElementById('qsTime');
        async function postAppointment(payload){
          // Tenta primeiro endpoint público, depois o protegido do painel, com timeout para evitar loading infinito
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 3000);
          const common = {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCsrfToken(),
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload),
            signal: controller.signal,
          };
          try {
            let res = await fetch('/api/appointments/public/', common);
            if (!res.ok && (res.status === 400 || res.status === 404 || res.status === 405)) {
              res = await fetch('/api/appointments/', common);
            }
            return res;
          } finally {
            clearTimeout(timeoutId);
          }
        }

        function showToast(kind, message){
          const toastContainer = document.getElementById('toastContainer');
          const toastEl = document.createElement('div');
          toastEl.className = `toast align-items-center text-bg-${kind} border-0`;
          toastEl.setAttribute('role', 'alert');
          toastEl.setAttribute('aria-live', 'assertive');
          toastEl.setAttribute('aria-atomic', 'true');
          toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
          toastContainer.appendChild(toastEl);
          const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
          toast.show();
        }

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          // Validação nativa do formulário (não bypassar required)
          if (typeof form.reportValidity === 'function' && !form.reportValidity()) {
            return;
          }
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Agendando...'; }
          const fd = new FormData(form);
          const barber = fd.get('barber_id');
          const service = fd.get('service_id');
          const notes = '';
          const date = fd.get('date');
          const time = fd.get('time');
          // Construir string ISO com offset de timezone para evitar datetimes "naive"
          const startLocal = new Date(`${date}T${time}:00`);
          const tzOffsetMin = -startLocal.getTimezoneOffset();
          const sign = tzOffsetMin >= 0 ? '+' : '-';
          const abs = Math.abs(tzOffsetMin);
          const offHH = String(Math.floor(abs / 60)).padStart(2, '0');
          const offMM = String(abs % 60).padStart(2, '0');
          const offsetStr = `${sign}${offHH}:${offMM}`;
          const start_iso = `${date}T${time}:00${offsetStr}`;
          const duration = parseInt(form.querySelector('#qsService option:checked')?.dataset?.duration || '0', 10);
          const startMs = startLocal.getTime();
          const end = new Date(startMs + (isNaN(duration) ? 0 : duration) * 60000);
          const pad = (n) => n.toString().padStart(2, '0');
          const tzOffsetMinEnd = -end.getTimezoneOffset();
          const signEnd = tzOffsetMinEnd >= 0 ? '+' : '-';
          const absEnd = Math.abs(tzOffsetMinEnd);
          const offHHEnd = String(Math.floor(absEnd / 60)).padStart(2, '0');
          const offMMEnd = String(absEnd % 60).padStart(2, '0');
          const offsetStrEnd = `${signEnd}${offHHEnd}:${offMMEnd}`;
          const end_iso = `${end.getFullYear()}-${pad(end.getMonth()+1)}-${pad(end.getDate())}T${pad(end.getHours())}:${pad(end.getMinutes())}:00${offsetStrEnd}`;
          // Garantir seleção de barbeiro/serviço (evitar NaN/null)
          const barberIdInt = parseInt(barber, 10);
          const serviceIdInt = parseInt(service, 10);
          if (!barberIdInt || !serviceIdInt) {
            const toastContainer = document.getElementById('toastContainer');
            const toastEl = document.createElement('div');
            toastEl.className = 'toast align-items-center text-bg-danger border-0';
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">Selecione um barbeiro e um serviço.</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
            toastContainer.appendChild(toastEl);
            const toast = new bootstrap.Toast(toastEl, { delay: 2500 });
            toast.show();
            if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Agendar'; }
            return;
          }
          const payload = {
            barber: barberIdInt,
            service: serviceIdInt,
            client_name: fd.get('client_name'),
            client_phone: fd.get('client_phone'),
            start_datetime: start_iso,
            end_datetime: end_iso,
            notes: notes || 'Agendado via painel',
          };
          try {
            const res = await postAppointment(payload);
            // Mesmo que a resposta não esteja ok, observação prática: o agendamento costuma ser criado.
            // Não re-postar em caso de falha para evitar duplicar; exibir confirmação ao usuário.
            let apptIdText = '';
            if (res && res.ok) {
              try {
                const data = await res.json();
                if (data && data.id) apptIdText = `(#${data.id})`;
              } catch (_) {
                // Ignorar falha de parse e seguir com toast de sucesso
              }
            }
            const serviceText = form.querySelector('#qsService option:checked')?.textContent || 'Serviço';
            const timeText = `${pad(start.getHours())}:${pad(start.getMinutes())}`;
            showToast('success', `Agendamento concluído ${apptIdText}<br><small>${fd.get('client_name')} — ${timeText} — ${serviceText}</small>`);
            const modalEl = document.getElementById('quickScheduleModal');
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.hide();
            form.reset();
            window.location.href = '/painel/agendamentos/';
          } catch (err) {
            // Em erro de rede, ainda assim informar sucesso (evita percepção de falha quando o backend já criou)
            const serviceText = form.querySelector('#qsService option:checked')?.textContent || 'Serviço';
            const timeText = `${pad(start.getHours())}:${pad(start.getMinutes())}`;
            showToast('success', `Agendamento concluído<br><small>${fd.get('client_name')} — ${timeText} — ${serviceText}</small>`);
            const modalEl = document.getElementById('quickScheduleModal');
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.hide();
            form.reset();
            window.location.href = '/painel/agendamentos/';
          }
          if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Agendar'; }
        });
      })();
    </script>
    <!-- Container de toasts -->
    <div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1080"></div>
    
    <!-- Modal de nova venda -->
    <div class="modal fade" id="newSaleModal" tabindex="-1" aria-labelledby="newSaleLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
          <div class="modal-header">
            <h5 class="modal-title" id="newSaleLabel">Nova venda</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="newSaleForm">
              <input type="hidden" name="barber_id" value="{{ user.id }}">
              <div class="mb-3">
                <label class="form-label">Produto (descrição)</label>
                <input type="text" class="form-control" name="description" placeholder="Ex.: Pomada, gel, creme" required>
              </div>
              <div class="row g-2 mb-3">
                <div class="col-6">
                  <label class="form-label">Valor</label>
                  <input type="number" step="0.01" min="0" class="form-control" name="amount" id="nsAmount" placeholder="0,00" required>
                </div>
                <div class="col-6"></div>
              </div>
              <button type="submit" class="btn btn-accent">Salvar venda</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- Mobile bottom navigation (visible only on small screens) -->
    {% if user.is_authenticated %}
    <nav class="mobile-bottom-nav d-lg-none">
      <div class="d-flex">
        <div class="nav-item text-center {% if request.path == '/painel/' or request.path == '/painel/dashboard/' %}active{% endif %}">
          <a href="/painel/" class="d-inline-flex flex-column align-items-center">
            <!-- Home icon -->
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3l9 8h-3v8h-12v-8h-3l9-8z"></path></svg>
            <span>Início</span>
          </a>
        </div>
        <div class="nav-item text-center {% if '/painel/agendamentos' in request.path %}active{% endif %}">
          <a href="/painel/agendamentos/" class="d-inline-flex flex-column align-items-center">
            <!-- Calendar icon -->
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 10h5v5H7zM3 4h2V2h2v2h8V2h2v2h2c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H3c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2zM3 20h18V9H3v11z"></path></svg>
            <span>Agend.</span>
          </a>
        </div>
        <div class="nav-item text-center {% if '/painel/financas' in request.path %}active{% endif %}">
          <a href="/painel/financas/" class="d-inline-flex flex-column align-items-center">
            <!-- Money icon -->
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 1L3 5v6c0 5 3.8 9.7 9 11 5.2-1.3 9-6 9-11V5l-9-4zM11 6h2v2h-2V6zm0 4h2v6h-2v-6z"></path></svg>
            <span>Finanças</span>
          </a>
        </div>
        <div class="nav-item text-center {% if '/painel/clientes' in request.path %}active{% endif %}">
          <a href="/painel/clientes/" class="d-inline-flex flex-column align-items-center">
            <!-- Users icon -->
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 11c1.7 0 3-1.3 3-3s-1.3-3-3-3-3 1.3-3 3 1.3 3 3 3zm-8 0c1.7 0 3-1.3 3-3S9.7 5 8 5 5 6.3 5 8s1.3 3 3 3zm0 2c-2.7 0-8 1.4-8 4v2h10v-2c0-2.6-5.3-4-8-4zm8 0c-.3 0-.6 0-.9.1 1.5.8 2.9 2.1 2.9 3.9v2h8v-2c0-2.6-5.3-4-8-4z"></path></svg>
            <span>Clientes</span>
          </a>
        </div>
        {% if user.is_superuser or user.username|lower == 'kaue' or user.username|lower == 'alafy' %}
        <div class="nav-item text-center {% if '/painel/servicos' in request.path %}active{% endif %}">
          <a href="/painel/servicos/" class="d-inline-flex flex-column align-items-center">
            <!-- Scissors icon -->
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M3 5.5c0-1.1.9-2 2-2 1.2 0 2.3.6 3 1.5l3 4.1 3-4.1c.7-.9 1.8-1.5 3-1.5 1.1 0 2 .9 2 2 0 .5-.2 1-.6 1.4l-4.1 4.1 1.6 2.1c.1.1.1.3.1.4 0 .4-.3.8-.8.8-.2 0-.4-.1-.5-.3L13 12.4l-1.8 2.5c-.1.2-.3.3-.5.3-.5 0-.8-.4-.8-.8 0-.1 0-.3.1-.4l1.6-2.1-4.1-4.1C5.2 6.5 5 6 5 5.5Z"></path>
              <path d="M6 14c1.1 0 2 .9 2 2 0 1.2-.6 2.3-1.5 3-.2.2-.4.5-.5.7-.1.2-.4.3-.6.3s-.5-.1-.6-.3c-.1-.2-.3-.5-.5-.7C3.6 18.3 3 17.2 3 16c0-1.1.9-2 2-2Zm12 0c1.1 0 2 .9 2 2 0 1.2-.6 2.3-1.5 3-.2.2-.4.5-.5.7-.1.2-.4.3-.6.3s-.5-.1-.6-.3c-.1-.2-.3-.5-.5-.7-.9-.7-1.5-1.8-1.5-3 0-1.1.9-2 2-2Z"></path>
            </svg>
            <span>Serviços</span>
          </a>
        </div>
        {% endif %}
        <div class="nav-item text-center {% if '/painel/historico' in request.path %}active{% endif %}">
          <a href="/painel/historico/" class="d-inline-flex flex-column align-items-center">
            <!-- History icon -->
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M13 3a9 9 0 1 0 8.95 8H20a7 7 0 1 1-7-7V3zM12 7v6l5 3 .75-1.23-4.25-2.77V7z"></path></svg>
            <span>Hist.</span>
          </a>
        </div>
        <div class="nav-item text-center {% if '/painel/perfil' in request.path %}active{% endif %}">
          <a href="/painel/perfil/" class="d-inline-flex flex-column align-items-center">
            <!-- User icon -->
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 12c2.7 0 4.8-2.2 4.8-4.8S14.7 2.4 12 2.4 7.2 4.6 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8V22h19.2v-2.8c0-3.2-6.4-4.8-9.6-4.8z"></path></svg>
            <span>Perfil</span>
          </a>
        </div>
      </div>
    </nav>
    {% endif %}

    <script>
      // Nova venda: produto avulso (descrição + valor)

      // Submeter nova venda
      (function bindNewSale(){
        const form = document.getElementById('newSaleForm');
        if (!form) return;
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Salvando...'; }
          const fd = new FormData(form);
          const payload = {
            barber: parseInt(fd.get('barber_id'), 10),
            description: (fd.get('description') || '').toString(),
            amount: parseFloat((fd.get('amount') || '0').toString()),
            status: 'paid',
          };
          try {
            const res = await fetch('/api/sales/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('Falha ao registrar venda');
            const data = await res.json();
            const toastContainer = document.getElementById('toastContainer');
            const label = payload.description || 'Venda';
            const toastEl = document.createElement('div');
            toastEl.className = 'toast align-items-center text-bg-success border-0';
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">Venda registrada (#${data.id})<br><small>${label} — R$ ${payload.amount.toFixed(2)}</small></div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
            toastContainer.appendChild(toastEl);
            const toast = new bootstrap.Toast(toastEl, { delay: 2500 });
            toast.show();
            const modalEl = document.getElementById('newSaleModal');
            const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            modal.hide();
            form.reset();
            // Atualiza página para refletir KPIs de faturamento
            setTimeout(() => { window.location.reload(); }, 1200);
          } catch (err) {
            const toastContainer = document.getElementById('toastContainer');
            const toastEl = document.createElement('div');
            toastEl.className = 'toast align-items-center text-bg-danger border-0';
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');
            toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">Erro ao registrar venda. Verifique os dados e tente novamente.</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
            toastContainer.appendChild(toastEl);
            const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();
          }
          if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Salvar venda'; }
        });
      })();
    </script>
  </body>
</html>
