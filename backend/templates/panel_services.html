{% extends "base.html" %}
{% block title %}Serviços | Painel Dlux{% endblock %}
{% block content %}

<div class="d-flex flex-wrap align-items-center justify-content-between mb-4 gap-2">
  <div>
    <h2 class="mb-1 d-none d-md-block">Serviços</h2>
  </div>
  <div class="text-end">
    <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCreate" aria-expanded="false" aria-controls="collapseCreate">
      <span class="d-none d-sm-inline">Novo Serviço</span>
      <span class="d-inline d-sm-none">+</span>
    </button>
  </div>
</div>

{% if services|length >= 45 %}
<div class="alert alert-warning alert-dismissible fade show" role="alert">
  Aviso: você possui {{ services|length }} serviços. O limite é 50.
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
</div>
{% endif %}

<!-- Create Service Collapse -->
<div class="collapse mb-4" id="collapseCreate">
  <div class="card card-panel border-success">
    <div class="card-header border-success text-success">
      <h5 class="mb-0">Adicionar Novo Serviço</h5>
    </div>
    <div class="card-body">
      <form onsubmit="saveService(event)">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nome do Serviço</label>
            <input type="text" class="form-control panel-input" name="title" placeholder="Ex.: Corte Degradê" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Preço (R$)</label>
            <input type="text" class="form-control panel-input text-end" name="price" placeholder="0,00" inputmode="decimal" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Duração (min)</label>
            <input type="number" class="form-control panel-input" name="duration_minutes" placeholder="30" required>
          </div>
          <div class="col-12 d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#collapseCreate">Cancelar</button>
            <button type="submit" class="btn btn-success">Criar Serviço</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  .panel-input {
    background: #0f0f12;
    border: 1px solid #222;
    color: #eaeaea;
  }
  .panel-input:focus {
    box-shadow: 0 0 0 0.15rem rgba(197,157,95,0.12);
    border-color: #c59d5f;
    background: #111;
    color: #fff;
  }
  .service-card-header {
    cursor: pointer;
    transition: background-color 0.2s;
  }
  .service-card-header:hover {
    background-color: #1a1a1d;
  }
  .badge-active {
    background: rgba(16, 185, 129, 0.15);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.2);
  }
  .badge-inactive {
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.2);
  }
</style>

<div class="d-flex flex-column gap-3" id="servicesList">
  {% for service in services %}
  <div class="card card-panel shadow-sm border-secondary">
    <div class="card-header service-card-header d-flex align-items-center justify-content-between p-3" 
         data-bs-toggle="collapse" data-bs-target="#collapse{{ service.id }}" aria-expanded="false">
      <div class="d-flex align-items-center gap-3">
        <h5 class="mb-0 text-white">{{ service.title }}</h5>
        <span class="badge {% if service.active %}badge-active{% else %}badge-inactive{% endif %} rounded-pill">
          {% if service.active %}Ativo{% else %}Inativo{% endif %}
        </span>
      </div>
      <div class="text-white fw-bold">
        R$ {{ service.price|floatformat:"2" }}
      </div>
    </div>

    <div id="collapse{{ service.id }}" class="collapse">
      <div class="card-body border-top border-secondary bg-dark">
        <form onsubmit="saveService(event)" data-id="{{ service.id }}">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Nome do Serviço</label>
              <input type="text" class="form-control panel-input" name="title" value="{{ service.title }}" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Preço (R$)</label>
              <input type="text" class="form-control panel-input text-end" name="price" value="{{ service.price|floatformat:'2' }}" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Duração (min)</label>
              <input type="number" class="form-control panel-input" name="duration_minutes" value="{{ service.duration_minutes }}" required>
            </div>
            
            <div class="col-12">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="active" id="active{{ service.id }}" {% if service.active %}checked{% endif %}>
                <label class="form-check-label" for="active{{ service.id }}">Serviço Ativo (visível no agendamento)</label>
              </div>
            </div>

            <div class="col-12 d-flex justify-content-between align-items-center mt-3">
              <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteService(this)" data-id="{{ service.id }}">Excluir Serviço</button>
              <button type="submit" class="btn btn-primary">Salvar Alterações</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="text-center text-muted py-5">
    <p>Nenhum serviço cadastrado.</p>
  </div>
  {% endfor %}
</div>

<script>
  function csrftoken(){var m=document.cookie.match(/csrftoken=([^;]+)/);return m?m[1]:''}

  function saveService(event) {
    event.preventDefault();
    const form = event.target;
    const id = form.dataset.id;
    const isCreate = !id;
    
    const title = form.querySelector('[name="title"]').value;
    const priceStr = form.querySelector('[name="price"]').value;
    const duration = form.querySelector('[name="duration_minutes"]').value;
    // For create, active might not exist in form if I didn't add it, but I should.
    // In create form above, I didn't add active checkbox. Let's assume active=true for new.
    // Or add it. I'll stick to default true for new.
    let active = true;
    const activeInput = form.querySelector('[name="active"]');
    if (activeInput) active = activeInput.checked;

    const price = parseFloat(String(priceStr).replace(/\./g,'').replace(',','.'));
    
    const payload = {
      title: title.trim(),
      price: price,
      duration_minutes: parseInt(duration, 10),
      active: active
    };

    const url = isCreate ? '/api/services/' : '/api/services/' + id + '/';
    const method = isCreate ? 'POST' : 'PATCH';

    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken()
      },
      body: JSON.stringify(payload)
    })
    .then(r => r.json().then(d => ({ ok: r.ok, data: d })))
    .then(res => {
      if (res.ok) {
        window.location.reload();
      } else {
        alert('Erro ao salvar: ' + JSON.stringify(res.data));
      }
    })
    .catch(err => {
      alert('Erro de conexão.');
      console.error(err);
    });
  }

  function deleteService(btn) {
    const id = btn.dataset.id;
    if (!confirm('Tem certeza que deseja excluir este serviço?')) return;
    fetch('/api/services/' + id + '/', {
      method: 'DELETE',
      headers: { 'X-CSRFToken': csrftoken() }
    })
    .then(r => {
      if (r.ok) {
        window.location.reload();
      } else {
        alert('Erro ao excluir.');
      }
    })
    .catch(err => console.error(err));
  }
</script>
{% endblock %}
