{% extends 'base.html' %}
{% block title %}Finanças{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0 d-none d-md-block">Finanças</h3>
  <div>
    <a id="exportCsvBtn" href="#" class="btn btn-sm btn-accent d-inline-flex align-items-center">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download me-2" viewBox="0 0 16 16">
        <path d="M.5 9.9a.5.5 0 0 1 .5-.5h3.5V1.5a.5.5 0 0 1 1 0v7.9H9a.5.5 0 0 1 .354.854l-2.5 2.5a.5.5 0 0 1-.708 0l-2.5-2.5A.5.5 0 0 1 3.5 9.4H1a.5.5 0 0 1-.5-.5Z"/>
        <path d="M.5 15a.5.5 0 0 0 .5.5h14a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-1 0v2.5H1V12a.5.5 0 0 0-1 0v3Z"/>
      </svg>
      Exportar CSV (visão atual)
      </a>
    {% if can_withdraw %}
    <button type="button" class="btn btn-sm btn-danger ms-2" data-bs-toggle="modal" data-bs-target="#withdrawModal">
      Retirada
    </button>
    {% endif %}
  </div>
</div>

<!-- Mobile KPI scroller (small screens) -->
<div class="d-lg-none mb-2">
  <div class="kpi-scroller">
    <div class="kpi-card-row">
      <div class="card card-panel kpi-card">
        <div class="card-body">
          <div class="kpi">R$ {{ kpis.today_revenue }}</div>
          <div class="kpi-label">Faturamento Hoje</div>
        </div>
      </div>
      <div class="card card-panel kpi-card">
        <div class="card-body">
          <div class="kpi">R$ {{ kpis.month_revenue }}</div>
          <div class="kpi-label">Faturamento Mês</div>
        </div>
      </div>
      <div class="card card-panel kpi-card">
        <div class="card-body">
          <div class="kpi">{{ kpis.appts_cancelled }}</div>
          <div class="kpi-label">Cancelados Hoje</div>
        </div>
      </div>
      {% if not is_admin %}
      <div class="card card-panel kpi-card">
        <div class="card-body">
          <div class="kpi">R$ {{ kpis.barber_share_month }}</div>
          <div class="kpi-label">Participação (Mês)</div>
        </div>
      </div>
      {% if is_special_finances_view %}
      <div class="card card-panel kpi-card">
        <div class="card-body">
          <div class="kpi">R$ {{ kpis.month_total_all }}</div>
          <div class="kpi-label">Faturamento Total (Mês)</div>
        </div>
      </div>
      {% endif %}
      {% endif %}
    </div>
  </div>
  <div class="kpi-scroller-indicator">Role para ver mais →</div>
</div>

<!-- Desktop KPI grid -->
<div class="row g-3 mb-4 d-none d-lg-flex">
  <div class="col-sm-6 col-lg">
    <div class="card card-panel">
      <div class="card-body">
        <div class="kpi">R$ {{ kpis.today_revenue }}</div>
        <div class="kpi-label">Faturamento Hoje</div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg">
    <div class="card card-panel">
      <div class="card-body">
        <div class="kpi">R$ {{ kpis.month_revenue }}</div>
        <div class="kpi-label">Faturamento no Mês</div>
      </div>
    </div>
  </div>
  
  <div class="col-sm-6 col-lg">
    <div class="card card-panel">
      <div class="card-body">
        <div class="kpi">{{ kpis.appts_cancelled }}</div>
        <div class="kpi-label">Cancelados Hoje</div>
      </div>
    </div>
  </div>
  {% if not is_admin %}
  <div class="col-sm-6 col-lg">
    <div class="card card-panel">
      <div class="card-body">
        <div class="kpi">R$ {{ kpis.barber_share_month }}</div>
        <div class="kpi-label">Participação de Serviços (Mês)</div>
      </div>
    </div>
  </div>
  {% if is_special_finances_view %}
  <div class="col-sm-6 col-lg">
    <div class="card card-panel">
      <div class="card-body">
        <div class="kpi">R$ {{ kpis.month_total_all }}</div>
        <div class="kpi-label">Faturamento Total (Mês)</div>
      </div>
    </div>
  </div>
  {% endif %}
  {% endif %}
</div>

{% if can_withdraw %}
<div class="modal fade" id="withdrawModal" tabindex="-1" aria-labelledby="withdrawModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="withdrawModalLabel">Registrar retirada de caixa</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post">
        {% csrf_token %}
        <div class="modal-body">
          <div class="form-floating mb-3">
            <input type="number" step="0.01" min="0" class="form-control bg-dark text-light border-secondary" id="withdrawAmount" name="withdraw_amount" placeholder="0,00" required>
            <label for="withdrawAmount">Valor (R$)</label>
          </div>
          <div class="form-floating mb-3">
            <select class="form-select bg-dark text-light border-secondary" id="withdrawReason" name="withdraw_reason" required>
              <option value="Itens básicos">Itens básicos</option>
              <option value="Aluguel/Agua/Luz">Aluguel/Agua/Luz</option>
              <option value="Produtos freezer">Produtos freezer</option>
              <option value="Outros">Outros</option>
            </select>
            <label for="withdrawReason">Motivo da retirada</label>
          </div>
          <div class="form-floating">
            <textarea class="form-control bg-dark text-light border-secondary" placeholder="Observação (opcional)" id="withdrawNote" name="withdraw_note" style="height: 100px"></textarea>
            <label for="withdrawNote">Observação (opcional)</label>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Confirmar retirada</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="row g-3">
  <div class="col-12">
    <div class="card widget-card bg-dark text-light border-secondary shadow-sm mb-4">
      <div class="card-body p-4">
        <div class="d-block d-sm-flex align-items-center justify-content-between mb-3">
          <div class="mb-3 mb-sm-0">
            <h5 class="card-title widget-card-title">Ocupação por Horário</h5>
          </div>
          <div class="d-flex align-items-center gap-2">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="occupancyCompareSwitch">
              <label class="form-check-label fs-7" for="occupancyCompareSwitch">Comparar</label>
            </div>
            <select id="occupancyMonthSelect" class="form-select text-secondary border-light-subtle"></select>
            <select id="occupancyMonthCompareSelect" class="form-select text-secondary border-light-subtle" style="display:none"></select>
            <button class="collapse-toggle ms-2" data-bs-toggle="collapse" data-bs-target="#occupancyBody" aria-expanded="true" aria-controls="occupancyBody" title="Minimizar/Expandir"><span class="icon">▾</span></button>
          </div>
        </div>
        <div id="occupancyBody" class="collapse show">
          <div class="row g-3 align-items-stretch" id="occupancyChartsRow">
            <div class="col-12 col-lg-12" id="occupancyMainCol">
              <div id="occupancyChart"></div>
            </div>
            <div class="col-12 col-lg-6" id="occupancyCompareCol" style="display:none">
              <div id="occupancyChartCompare"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="row g-3">
  <div class="col-lg-12">
    <div class="card widget-card bg-dark text-light border-secondary shadow-sm mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
          <span class="fw-semibold">Agendamentos concluídos</span>
        </div>
        <div class="d-flex align-items-center gap-2 chart-controls">
          <select id="chartRange" class="form-select form-select-sm">
            <option value="day">Hoje (por horário)</option>
            <option value="week">Últ. 7 dias</option>
            <option value="15">Últ. 15 dias</option>
            <option value="30" selected>Últ. 30 dias</option>
          </select>
          <div class="form-check form-switch ms-2">
            <input class="form-check-input" type="checkbox" id="chartCompare">
            <label class="form-check-label small" for="chartCompare">Comparar</label>
          </div>
          <button class="collapse-toggle ms-2" data-bs-toggle="collapse" data-bs-target="#chartBody" aria-expanded="true" aria-controls="chartBody" title="Minimizar/Expandir">
            <span class="icon">▾</span>
          </button>
        </div>
      </div>
      
      <div id="chartBody" class="collapse show card-body p-4">
        <div id="chart">
          <div id="timeline-chart"></div>
        </div>
      </div>
    </div>
  </div>

</div>

{% if is_admin %}
<div class="row g-3">
  <div class="col-12">
    <div class="card card-panel mb-4">
      <div class="card-header fw-semibold">Resumo por barbeiro (mês, concluídos)</div>
      <div class="card-body p-0">
        <table class="table table-dark table-striped mb-0">
          <thead>
            <tr>
              <th>Barbeiro</th>
              <th style="width: 120px;">Qtd</th>
              <th style="width: 160px;">Valor total</th>
            </tr>
          </thead>
          <tbody>
            {% for row in breakdown_by_barber %}
            <tr>
              <td>
                {% with display=row.barber__display_name username=row.barber__username %}
                  {% if display %}{{ display }}{% else %}{{ username }}{% endif %}
                {% endwith %}
              </td>
              <td>{{ row.count }}</td>
              <td>R$ {{ row.total_value }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="3" class="text-center muted">Sem registros nesse período.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="row g-3">
  <div class="col-12">
    <div class="card widget-card bg-dark text-light border-secondary shadow-sm mb-4">
      <div class="card-body p-4">
        <div class="d-block d-sm-flex align-items-center justify-content-between mb-3">
          <div class="mb-3 mb-sm-0">
            <h5 class="card-title widget-card-title">Receita Total</h5>
          </div>
          <div class="d-flex align-items-center gap-2">
            <select id="revenueMonthSelect" class="form-select text-secondary border-light-subtle">
            </select>
            <button class="collapse-toggle ms-2" data-bs-toggle="collapse" data-bs-target="#revChartBody" aria-expanded="true" aria-controls="revChartBody" title="Minimizar/Expandir"><span class="icon">▾</span></button>
          </div>
        </div>
        <div id="revChartBody" class="collapse show">
          <div id="bsb-chart-1"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-12">
    <div class="card widget-card bg-dark text-light border-secondary shadow-sm mb-4">
      <div class="card-body p-4">
        <div class="d-block d-sm-flex align-items-center justify-content-between mb-3">
          <div class="mb-3 mb-sm-0">
            <h5 class="card-title widget-card-title">Serviços mais agendados</h5>
          </div>
          <div class="d-flex align-items-center gap-2">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="servicesCompareSwitch">
              <label class="form-check-label fs-7" for="servicesCompareSwitch">Comparar</label>
            </div>
            <select id="servicesMonthSelect" class="form-select text-secondary border-light-subtle"></select>
            <select id="servicesMonthCompareSelect" class="form-select text-secondary border-light-subtle" style="display:none"></select>
            <button class="collapse-toggle ms-2" data-bs-toggle="collapse" data-bs-target="#servicesBody" aria-expanded="true" aria-controls="servicesBody" title="Minimizar/Expandir"><span class="icon">▾</span></button>
          </div>
        </div>
        <div id="servicesBody" class="collapse show">
          <div class="row g-3 align-items-stretch" id="servicesChartsRow">
            <div class="col-12 col-lg-6">
              <div id="bsb-chart-4"></div>
            </div>
            <div class="col-12 col-lg-6" id="servicesCompareCol" style="display:none">
              <div id="bsb-chart-4-compare"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-12">
    <div class="card widget-card bg-dark text-light border-secondary shadow-sm mb-4">
      <div class="card-body p-4">
        <div class="d-block d-sm-flex align-items-center justify-content-between mb-3">
          <div class="mb-3 mb-sm-0">
            <h5 class="card-title widget-card-title">Quantidade de servicos por barbeiro</h5>
          </div>
          <div class="d-flex align-items-center gap-2">
            <select id="barberRangeSelect" class="form-select text-secondary border-light-subtle"></select>
            <button class="collapse-toggle ms-2" data-bs-toggle="collapse" data-bs-target="#barberChartBody" aria-expanded="true" aria-controls="#barberChartBody" title="Minimizar/Expandir"><span class="icon">▾</span></button>
          </div>
        </div>
        <div id="barberChartBody" class="collapse show">
          <div class="row g-3 align-items-start">
            <div class="col-12 col-md-4">
              <div id="barberSideList"></div>
            </div>
            <div class="col-12 col-md-8">
              <div id="bsb-chart-7"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% if not is_admin and is_special_finances_view %}
<div class="row g-3">
  <div class="col-12">
    <div class="card widget-card bg-dark text-light border-secondary shadow-sm mb-4">
      <div class="card-body p-4">
        <div class="d-block d-sm-flex align-items-center justify-content-between mb-3">
          <div class="mb-3 mb-sm-0">
            <h5 class="card-title widget-card-title">Retiradas por motivo (mês)</h5>
          </div>
          <div>
            <button class="collapse-toggle ms-2" data-bs-toggle="collapse" data-bs-target="#funnelChartBody" aria-expanded="true" aria-controls="funnelChartBody" title="Minimizar/Expandir"><span class="icon">▾</span></button>
          </div>
        </div>
        <div id="funnelChartBody" class="collapse show">
          <div id="bsb-chart-funnel"></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="row g-3">
  <div class="col-12">
    <div class="card widget-card bg-dark text-light border-secondary shadow-sm mb-4">
      <div class="card-body p-4">
        <div class="d-block d-sm-flex align-items-center justify-content-between mb-3">
          <div class="mb-3 mb-sm-0">
            <h5 class="card-title widget-card-title">Taxa de Cancelamento</h5>
          </div>
          <div>
            <button class="collapse-toggle ms-2" data-bs-toggle="collapse" data-bs-target="#noShowChartBody" aria-expanded="true" aria-controls="noShowChartBody" title="Minimizar/Expandir"><span class="icon">▾</span></button>
          </div>
        </div>
        <div id="noShowChartBody" class="collapse show">
          <div id="noShowChart"></div>
        </div>
      </div>
  </div>
</div>
</div>
{% endif %}

<div class="row g-3">
  <div class="col-12">
    <div class="card widget-card bg-dark text-light border-secondary shadow-sm mb-4">
      <div class="card-body p-4">
        <div class="d-block d-sm-flex align-items-center justify-content-between mb-3">
          <div class="mb-3 mb-sm-0">
            <h5 class="card-title widget-card-title">Clientes Mais Frequentes</h5>
          </div>
          <div class="d-flex align-items-center gap-2">
            <select id="clientsTopRangeSelect" class="form-select text-secondary border-light-subtle"></select>
            <button class="collapse-toggle ms-2" data-bs-toggle="collapse" data-bs-target="#clientsTopBody" aria-expanded="true" aria-controls="clientsTopBody" title="Minimizar/Expandir"><span class="icon">▾</span></button>
          </div>
        </div>
        <div id="clientsTopBody" class="collapse show">
          <div id="clientsTopChart"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
  function showToast(msg, type='danger') {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    const el = document.createElement('div');
    el.className = `toast align-items-center text-bg-${type} border-0 show`;
    el.setAttribute('role', 'alert');
    el.setAttribute('aria-live', 'assertive');
    el.setAttribute('aria-atomic', 'true');
    el.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${msg}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    container.appendChild(el);
    setTimeout(() => { el.remove(); }, 5000);
  }

  // Toggle collapse icon direction for collapse-toggle buttons
  (function(){
    const btn = document.getElementById('exportCsvBtn');
    function buildUrl(){
      const params = new URLSearchParams();
      params.set('export','csv');
      const chartRangeEl = document.getElementById('chartRange');
      const chartCompareEl = document.getElementById('chartCompare');
      const includeEditedEl = document.getElementById('chartIncludeEdited');
      const servicesMonthEl = document.getElementById('servicesMonthSelect');
      const servicesMonthCompareEl = document.getElementById('servicesMonthCompareSelect');
      const servicesCompareSwitchEl = document.getElementById('servicesCompareSwitch');
      const barberRangeEl = document.getElementById('barberRangeSelect');
      if (chartRangeEl) params.set('timeline_range', chartRangeEl.value || '30');
      if (chartCompareEl) params.set('timeline_compare', chartCompareEl.checked ? '1' : '0');
      if (includeEditedEl) params.set('include_edited', includeEditedEl.checked ? '1' : '0');
      if (servicesMonthEl) params.set('services_month', servicesMonthEl.value || '');
      if (servicesCompareSwitchEl) params.set('services_compare', servicesCompareSwitchEl.checked ? '1' : '0');
      if (servicesMonthCompareEl && servicesMonthCompareEl.style.display !== 'none') params.set('services_month_compare', servicesMonthCompareEl.value || '');
      if (barberRangeEl) params.set('barber_range', barberRangeEl.value || '30');
      return `/painel/financas/?${params.toString()}`;
    }
    if (btn){
      btn.addEventListener('click', function(e){
        e.preventDefault();
        const url = buildUrl();
        window.location.href = url;
      });
    }
    const toggles = document.querySelectorAll('.collapse-toggle');
    toggles.forEach(btn => {
      const target = btn.getAttribute('data-bs-target');
      if (!target) return;
      const el = document.querySelector(target);
      const icon = btn.querySelector('.icon');
      if (!el || !icon) return;
      el.addEventListener('shown.bs.collapse', () => { icon.textContent = '▾'; });
      el.addEventListener('hidden.bs.collapse', () => { icon.textContent = '▸'; });
      // set initial state
      if (el.classList.contains('show')) icon.textContent = '▾'; else icon.textContent = '▸';
    });
  })();

  (function(){
    const el = document.getElementById('bsb-chart-funnel');
    if (!el) return;
    
    let chart = null;
    
    async function fetchFunnel(){
      try{
        const res = await fetch('/painel/financas/withdrawals-funnel-data/', { credentials: 'same-origin' });
        if(!res.ok) throw new Error('Falha ao obter retiradas');
        const json = await res.json();
        const labels = json.labels || [];
        const series = (json.series || []).map(v => Number(v || 0));
        
        if (labels.length === 0) {
           el.innerHTML = '<div class="text-center text-muted py-5">Sem retiradas no período.</div>';
           return;
        }

        const options = {
          series: [{
            name: 'Valor (R$)',
            data: series
          }],
          chart: {
            type: 'bar',
            height: 350,
            toolbar: { show: false },
            fontFamily: 'inherit',
            background: 'transparent'
          },
          theme: { mode: 'dark' },
          plotOptions: {
            bar: {
              borderRadius: 4,
              horizontal: true,
              distributed: true
            }
          },
          colors: ['#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545', '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0'],
          dataLabels: {
            enabled: true,
            formatter: function (val) {
              return "R$ " + val.toFixed(2).replace('.', ',');
            }
          },
          xaxis: {
            categories: labels,
            labels: {
              style: { colors: '#adb5bd' },
              formatter: function(val) { return "R$ " + val; }
            }
          },
          yaxis: {
            labels: {
              style: { colors: '#adb5bd' }
            }
          },
          grid: {
            borderColor: 'rgba(255,255,255,0.1)'
          },
          tooltip: {
            y: {
              formatter: function (val) {
                return "R$ " + val.toFixed(2).replace('.', ',');
              }
            }
          }
        };

        if(chart) {
            chart.updateOptions(options);
        } else {
            chart = new ApexCharts(el, options);
            chart.render();
        }
      }catch(e){ 
        console.error(e);
        el.innerHTML = '<div class="text-center text-danger py-5">Erro ao carregar dados.</div>';
        showToast('Erro ao carregar gráfico de retiradas');
      }
    }
    fetchFunnel();
  })();

  // ApexCharts: Taxa de No-Show e Cancelamento
  (function(){
    const el = document.getElementById('noShowChart');
    const body = document.getElementById('noShowChartBody');
    if(!el) return;
    
    let chart = null;

    function render(labels, doneRate, cancelRate){
      const options = {
        chart: { type: 'area', height: 320, toolbar: {show: false}, background: 'transparent' },
        colors: ['#00E396', '#FF4560'],
        series: [
          { name: 'Concluídos', data: doneRate },
          { name: 'Cancelados/Não compareceu', data: cancelRate }
        ],
        xaxis: { categories: labels, labels: { style: { colors: '#adb5bd' } } },
        yaxis: { max: 100, labels: { style: { colors: '#adb5bd' } } },
        theme: { mode: 'dark' },
        dataLabels: { enabled: false },
        stroke: { curve: 'smooth', width: 2 },
        fill: { type: 'gradient', gradient: { opacityFrom: 0.6, opacityTo: 0.1 } },
        grid: { borderColor: 'rgba(255,255,255,0.1)' }
      };

      if(chart) {
        chart.updateOptions(options);
      } else {
        chart = new ApexCharts(el, options);
        chart.render();
      }
    }

    async function fetchData(){
      try{
        const r = await fetch('/painel/financas/no-show-rate/', { credentials: 'same-origin' });
        if(!r.ok) throw new Error('Falha');
        const j = await r.json();
        const labels = j.labels || [];
        const doneRate = (j.series && j.series.done_rate) || [];
        const cancelRate = (j.series && j.series.cancel_rate) || [];
        render(labels, doneRate, cancelRate);
      }catch(e){ 
        console.error(e);
        showToast('Erro ao carregar taxa de cancelamento');
      }
    }
    fetchData();
    body && body.addEventListener('shown.bs.collapse', fetchData);
  })();

  // ApexCharts: Clientes mais frequentes
  (function(){
    const el = document.getElementById('clientsTopChart');
    const body = document.getElementById('clientsTopBody');
    const sel = document.getElementById('clientsTopRangeSelect');
    if(!el || !sel) return;
    
    let chart = null;

    function render(data){
      // data is [['Name', count], ...]
      const names = data.map(x => x[0]);
      const counts = data.map(x => x[1]);

      const options = {
        chart: { type: 'bar', height: 320, toolbar: {show: false}, background: 'transparent' },
        series: [{ name: 'Visitas', data: counts }],
        xaxis: { categories: names, labels: { style: { colors: '#adb5bd' } } },
        yaxis: { labels: { style: { colors: '#adb5bd' } } },
        theme: { mode: 'dark' },
        plotOptions: { bar: { borderRadius: 4, distributed: true } },
        colors: ['#00E396', '#FEB019', '#FF4560', '#775DD0', '#3F51B5', '#546E7A', '#26A69A', '#D10CE8', '#E91E63', '#29B6F6'],
        legend: { show: false },
        grid: { borderColor: 'rgba(255,255,255,0.1)' }
      };

      if(chart) {
        chart.updateOptions(options);
      } else {
        chart = new ApexCharts(el, options);
        chart.render();
      }
    }

    function buildOptions(){
      const now = new Date();
      const ranges = [
        { val: 'range:7', label: 'Últ. 7 dias' },
        { val: 'range:15', label: 'Últ. 15 dias' },
        { val: 'range:30', label: 'Últ. 30 dias' },
        { val: 'range:60', label: 'Últ. 60 dias' },
        { val: 'range:90', label: 'Últ. 90 dias' },
      ];
      const months = [];
      for(let i=0;i<3;i++){
        const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
        const val = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        const label = d.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        months.push({ val: `month:${val}`, label: label });
      }
      sel.innerHTML = '';
      ranges.forEach(o => { 
        const op = document.createElement('option'); 
        op.value = o.val; 
        op.textContent = o.label; 
        if(o.val === 'range:30') op.selected = true;
        sel.appendChild(op); 
      });
      months.forEach(o => { 
        const op = document.createElement('option'); 
        op.value = o.val; 
        op.textContent = o.label; 
        sel.appendChild(op); 
      });
    }

    async function fetchData(){
      const val = sel.value;
      let params = '';
      if (val.startsWith('range:')) {
        params = `range=${val.split(':')[1]}`;
      } else if (val.startsWith('month:')) {
        params = `month=${val.split(':')[1]}`;
      } else {
         if(val.includes('-')) params = `month=${val}`;
         else params = `range=30`;
      }
      try{
        const r = await fetch(`/painel/financas/clients-top-data/?${params}`, { credentials: 'same-origin' });
        if(!r.ok) throw new Error('Falha');
        const j = await r.json();
        const data = Array.isArray(j.data) ? j.data : [];
        render(data);
      }catch(e){ 
        console.error(e);
        showToast('Erro ao carregar clientes frequentes');
      }
    }
    
    buildOptions();
    fetchData();
    sel.addEventListener('change', fetchData);
    body && body.addEventListener('shown.bs.collapse', fetchData);
  })();

  // ApexCharts: Ocupação
  (function(){
    const el = document.getElementById('occupancyChart');
    const elCmp = document.getElementById('occupancyChartCompare');
    const body = document.getElementById('occupancyBody');
    const sel = document.getElementById('occupancyMonthSelect');
    const cmpSwitch = document.getElementById('occupancyCompareSwitch');
    const cmpSel = document.getElementById('occupancyMonthCompareSelect');
    const mainCol = document.getElementById('occupancyMainCol');
    const cmpCol = document.getElementById('occupancyCompareCol');
    
    if(!el || !sel || !cmpSwitch || !cmpSel || !mainCol || !cmpCol) return;
    
    let chart = null;
    let chartCmp = null;

    function render(chartInstance, container, data){
      // data is [{name: '08-10', y: 5}, ...]
      const labels = data.map(x => x.name);
      const series = data.map(x => x.y);
      
      const options = {
        chart: { type: 'donut', height: 320, background: 'transparent' },
        series: series,
        labels: labels,
        theme: { mode: 'dark' },
        plotOptions: { 
          pie: { 
            donut: { 
              labels: { 
                show: true, 
                total: { show: true, label: 'Total', color: '#adb5bd' } 
              } 
            } 
          } 
        },
        dataLabels: { enabled: false },
        stroke: { show: false }
      };

      if(chartInstance) {
        chartInstance.updateOptions(options);
        return chartInstance;
      } else {
        const c = new ApexCharts(container, options);
        c.render();
        return c;
      }
    }

    function buildOptions(){
      const now = new Date();
      const ranges = [
        { val: 'range:7', label: 'Últ. 7 dias' },
        { val: 'range:15', label: 'Últ. 15 dias' },
        { val: 'range:30', label: 'Últ. 30 dias' },
        { val: 'range:60', label: 'Últ. 60 dias' },
        { val: 'range:90', label: 'Últ. 90 dias' },
      ];
      const months = [];
      for(let i=0;i<3;i++){
        const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
        const val = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        const label = d.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        months.push({ val: `month:${val}`, label: label });
      }
      
      const populate = (element, defaultVal) => {
          element.innerHTML = '';
          ranges.forEach(o => { 
            const op = document.createElement('option'); 
            op.value = o.val; 
            op.textContent = o.label; 
            if(o.val === defaultVal) op.selected = true;
            element.appendChild(op); 
          });
          months.forEach(o => { 
            const op = document.createElement('option'); 
            op.value = o.val; 
            op.textContent = o.label; 
            element.appendChild(op); 
          });
      };
      
      populate(sel, 'range:30');
      populate(cmpSel, 'range:30');
    }

    async function fetchData(val, chartInstance, container){
      let params = '';
      if (val.startsWith('range:')) {
        params = `range=${val.split(':')[1]}`;
      } else if (val.startsWith('month:')) {
        params = `month=${val.split(':')[1]}`;
      } else {
         if(val.includes('-')) params = `month=${val}`;
         else params = `range=30`;
      }
      try{
        const r = await fetch(`/painel/financas/occupancy-buckets/?${params}`, { credentials: 'same-origin' });
        if(!r.ok) throw new Error('Falha');
        const j = await r.json();
        const data = Array.isArray(j.data) ? j.data : [];
        return render(chartInstance, container, data);
      }catch(e){ 
        console.error(e);
        showToast('Erro ao carregar ocupação');
        return chartInstance;
      }
    }

    async function update(){
        chart = await fetchData(sel.value, chart, el);
        if(cmpSwitch.checked){
            // Show compare
            mainCol.classList.remove('col-lg-12');
            mainCol.classList.add('col-lg-6');
            cmpCol.style.display = 'block';
            cmpSel.style.display = 'block';
            
            // Wait a bit for layout
            setTimeout(async () => {
                 chartCmp = await fetchData(cmpSel.value, chartCmp, elCmp);
            }, 50);
        } else {
            // Hide compare
            mainCol.classList.remove('col-lg-6');
            mainCol.classList.add('col-lg-12');
            cmpCol.style.display = 'none';
            cmpSel.style.display = 'none';
        }
        // Resize main chart after layout change
        setTimeout(() => {
            if(chart) chart.updateOptions({});
        }, 100);
    }
    
    buildOptions();
    update();
    
    sel.addEventListener('change', update);
    cmpSwitch.addEventListener('change', update);
    cmpSel.addEventListener('change', () => {
        if(cmpSwitch.checked) fetchData(cmpSel.value, chartCmp, elCmp).then(c => chartCmp = c);
    });
    body && body.addEventListener('shown.bs.collapse', update);
  })();
</script>

<!-- ApexCharts chart rendering -->
<script>
  (function(){
    const chartEl = document.querySelector('#timeline-chart');
    if (!chartEl) return;

    const defaultOptions = {
      chart: {
        type: 'area',
        height: 320,
        stacked: false,
        toolbar: { show: false },
        background: 'transparent',
        zoom: { enabled: false }
      },
      colors: ['#0090FF', '#00E396'],
      stroke: { curve: 'smooth', width: 3 },
      dataLabels: { enabled: false },
      markers: { size: 0, hover: { size: 6 } },
      xaxis: { type: 'datetime' },
      yaxis: { labels: { formatter: v => v } },
      tooltip: { x: { format: 'dd MMM yyyy HH:mm' }, enabled: true, custom: function(opts){ return '<div class="apexcharts-tooltip apexcharts-theme-light apexcharts-active">Loading...</div>'; } },
      legend: { position: 'top', horizontalAlign: 'left' },
      fill: { type: 'solid', opacity: 0.7 },
      series: [{ name: 'Período atual', data: [] }]
    };

    const chart = new ApexCharts(chartEl, defaultOptions);
    chart.render();

    const rangeSel = document.getElementById('chartRange');
    const compareEl = document.getElementById('chartCompare');
    const includeEditedEl = document.getElementById('chartIncludeEdited');

    let chartDetails = null;

    function buildTooltipHtml(ts){
      // ts is timestamp in ms
      const details = chartDetails && chartDetails.current ? (chartDetails.current[ts] || []) : [];
      let html = '<div class="apexcharts-tooltip apexcharts-theme-light apexcharts-active" style="padding:8px;min-width:160px">';
      html += `<div style="font-weight:600;margin-bottom:6px">Total: ${details.length}</div>`;
      if(details.length){
        html += '<div style="font-size:0.85rem">';
        details.forEach(s => { html += `<div>• ${s}</div>`; });
        html += '</div>';
      }
      html += '</div>';
      return html;
    }

    async function fetchDataAndUpdate(){
      const range = rangeSel.value;
      const compare = compareEl.checked ? 1 : 0;
      const include_edited = includeEditedEl ? (includeEditedEl.checked ? 1 : 0) : 0;
      const url = `/painel/financas/chart-data/?range=${encodeURIComponent(range)}&compare=${compare}&include_edited=${include_edited}`;
      try{
        const res = await fetch(url, { credentials: 'same-origin' });
        if (!res.ok) throw new Error('Falha ao obter dados');
        const json = await res.json();
        const series = json.series || [];
        chartDetails = json.details || null;
        // Ensure at least one series exists
        if (!series.length) {
          chart.updateSeries([{ name: 'Período atual', data: [] }]);
          return;
        }
        // Map series to expected colors: first blue, second green
        const s = series.map((it, i) => ({ name: it.name, data: it.data }));
        // If comparing and range is 'day', make the compare series label 'Ontem' for clarity
        if (compare && range === 'day' && s.length > 1) {
          s[1].name = 'Ontem';
        }
        // update tooltip custom to show services for current point
        chart.updateOptions({
          series: s,
          colors: ['#0090FF', '#00E396'],
          tooltip: {
            enabled: true,
            x: { format: (rangeSel.value === 'day') ? 'HH:mm' : 'dd MMM yyyy' },
            custom: function({series, seriesIndex, dataPointIndex, w}){
              try{
                const point = w.globals.series[seriesIndex] ? w.globals.series[seriesIndex][dataPointIndex] : null;
                // attempt to get timestamp from series data
                let ts = null;
                if(point && Array.isArray(series[seriesIndex].data) && series[seriesIndex].data[dataPointIndex]){
                  ts = series[seriesIndex].data[dataPointIndex][0];
                } else if(point && typeof point === 'number'){
                  ts = w.globals.seriesX[seriesIndex] ? w.globals.seriesX[seriesIndex][dataPointIndex] : null;
                }
                if(!ts && w.globals && w.globals.seriesX && w.globals.seriesX[0]){
                  ts = w.globals.seriesX[0][dataPointIndex];
                }
                if(!ts) return buildTooltipHtml(0);
                return buildTooltipHtml(ts);
              }catch(e){
                return buildTooltipHtml(0);
              }
            }
          }
        }, false, true);
      }catch(err){
        console.error('Chart fetch error', err);
        showToast('Erro ao carregar gráfico de agendamentos');
      }
    }

    // Bind controls
    [rangeSel, compareEl, includeEditedEl].forEach(el => el && el.addEventListener('change', fetchDataAndUpdate));

    // Initial load
    fetchDataAndUpdate();
  })();

  (function(){
    const revEl = document.querySelector('#bsb-chart-1');
    const monthSel = document.getElementById('revenueMonthSelect');
    if (!revEl || !monthSel) return;

    const revChart = new ApexCharts(revEl, {
      chart: { type: 'area', height: 320, stacked: false, toolbar: { show: false }, zoom: { enabled: false }, background: 'transparent' },
      theme: { mode: 'dark' },
      grid: { borderColor: 'transparent' },
      colors: ['var(--bs-primary)'],
      stroke: { curve: 'smooth', width: 3 },
      dataLabels: { enabled: false },
      markers: { size: 0 },
      fill: { type: 'gradient', gradient: { shadeIntensity: 1, inverseColors: false, opacityFrom: 0.12, opacityTo: 0.0, stops: [0, 90, 100] } },
      xaxis: { type: 'datetime', labels: { style: { colors: ['#a1aab2'] } } },
      yaxis: { labels: { formatter: v => `R$ ${Number(v || 0).toFixed(2)}` } },
      tooltip: { x: { format: 'dd MMM yyyy' }, y: { formatter: function(val){ return `R$ ${Number(val || 0).toFixed(2)}`; } } },
      legend: { show: false },
      series: [{ name: 'Receita líquida', data: [] }]
    });
    revChart.render();

    function buildMonthOptions(){
      const now = new Date();
      // Build standard range options
      const ranges = [
        { val: 'range:7', label: 'Últ. 7 dias' },
        { val: 'range:15', label: 'Últ. 15 dias' },
        { val: 'range:30', label: 'Últ. 30 dias' },
        { val: 'range:60', label: 'Últ. 60 dias' },
        { val: 'range:90', label: 'Últ. 90 dias' },
      ];

      // Build recent months options
      const months = [];
      for(let i=0;i<3;i++){
        const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
        const val = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        const label = d.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        months.push({ val: `month:${val}`, label: label });
      }

      monthSel.innerHTML = '';
      
      // Add ranges
      ranges.forEach(o => { 
        const op = document.createElement('option'); 
        op.value = o.val; 
        op.textContent = o.label; 
        // Default to 30 days if desired, or keep first. 
        if(o.val === 'range:30') op.selected = true;
        monthSel.appendChild(op); 
      });

      // Add separator or just append months
      months.forEach(o => { 
        const op = document.createElement('option'); 
        op.value = o.val; 
        op.textContent = o.label; 
        monthSel.appendChild(op); 
      });
    }

    async function fetchRevenue(){
      const val = monthSel.value;
      let params = '';
      if (val.startsWith('range:')) {
        params = `range=${val.split(':')[1]}`;
      } else if (val.startsWith('month:')) {
        params = `month=${val.split(':')[1]}`;
      } else {
         // Fallback for old values if any or default
         if(val.includes('-')) params = `month=${val}`;
         else params = `range=30`;
      }

      try{
        const res = await fetch(`/painel/financas/revenue-data/?${params}`, { credentials: 'same-origin' });
        if(!res.ok) throw new Error('Falha ao obter receita');
        const json = await res.json();
        const series = json.series || [];
        const s = series.map(it => ({ name: it.name, data: it.data }));
        revChart.updateSeries(s, true);
      }catch(e){ 
        console.error(e);
        showToast('Erro ao carregar receita');
      }
    }

    buildMonthOptions();
    fetchRevenue();
    monthSel.addEventListener('change', fetchRevenue);
  })();

  (function(){
    const el = document.querySelector('#bsb-chart-4');
    const sel = document.getElementById('servicesMonthSelect');
    const cmpSwitch = document.getElementById('servicesCompareSwitch');
    const cmpSel = document.getElementById('servicesMonthCompareSelect');
    const cmpCol = document.getElementById('servicesCompareCol');
    const elCmp = document.querySelector('#bsb-chart-4-compare');
    if (!el || !sel || !cmpSwitch || !cmpSel || !cmpCol || !elCmp) return;

    const donut = new ApexCharts(el, {
      chart: { type: 'donut', background: 'transparent' },
      theme: { mode: 'dark', palette: 'palette1' },
      dataLabels: { enabled: false },
      legend: { position: 'bottom' },
      plotOptions: {
        pie: {
          donut: {
            labels: {
              show: true,
              name: { fontSize: '22px', fontWeight: 600 },
              value: { fontSize: '16px', fontWeight: 400, formatter: function(v){ return `${parseInt(v||0)} concl.`; } }
            }
          }
        }
      },
      tooltip: { y: { formatter: function(v){ return `${parseInt(v||0)} concl.`; } } },
      labels: [],
      series: []
    });
    donut.render();

    let donutCmp = null;

    function buildMonthOptions(){
      const now = new Date();
      
      const ranges = [
        { val: 'range:7', label: 'Últ. 7 dias' },
        { val: 'range:15', label: 'Últ. 15 dias' },
        { val: 'range:30', label: 'Últ. 30 dias' },
        { val: 'range:60', label: 'Últ. 60 dias' },
        { val: 'range:90', label: 'Últ. 90 dias' },
      ];

      const months = [];
      for(let i=0;i<3;i++){
        const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
        const val = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        const label = d.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        months.push({ val: `month:${val}`, label: label });
      }
      
      sel.innerHTML = '';
      cmpSel.innerHTML = '';
      
      const populate = (el) => {
          ranges.forEach(o => { 
            const op = document.createElement('option'); 
            op.value = o.val; 
            op.textContent = o.label; 
            if(o.val === 'range:30') op.selected = true;
            el.appendChild(op); 
          });
          months.forEach(o => { 
            const op = document.createElement('option'); 
            op.value = o.val; 
            op.textContent = o.label; 
            el.appendChild(op); 
          });
      };
      
      populate(sel);
      populate(cmpSel);
    }

    async function fetchBreakdown(){
      const val = sel.value;
      let params = '';
      if (val.startsWith('range:')) {
        params = `range=${val.split(':')[1]}`;
      } else if (val.startsWith('month:')) {
        params = `month=${val.split(':')[1]}`;
      } else {
         if(val.includes('-')) params = `month=${val}`;
         else params = `range=30`;
      }
      try{
        const res = await fetch(`/painel/financas/services-breakdown-data/?${params}`, { credentials: 'same-origin' });
        if(!res.ok) throw new Error('Falha ao obter serviços');
        const json = await res.json();
        const labels = json.labels || [];
        const series = json.series || [];
        donut.updateOptions({ labels }, false, true);
        donut.updateSeries(series, true);
      }catch(e){ 
        console.error(e);
        showToast('Erro ao carregar serviços');
      }
    }

    async function fetchBreakdownCmp(){
      const val = cmpSel.value;
      if (!donutCmp) return;
      let params = '';
      if (val.startsWith('range:')) {
        params = `range=${val.split(':')[1]}`;
      } else if (val.startsWith('month:')) {
        params = `month=${val.split(':')[1]}`;
      } else {
         if(val.includes('-')) params = `month=${val}`;
         else params = `range=30`;
      }
      try{
        const res = await fetch(`/painel/financas/services-breakdown-data/?${params}`, { credentials: 'same-origin' });
        if(!res.ok) throw new Error('Falha ao obter serviços');
        const json = await res.json();
        const labels = json.labels || [];
        const series = json.series || [];
        donutCmp.updateOptions({ labels }, false, true);
        donutCmp.updateSeries(series, true);
      }catch(e){ 
        console.error(e);
        showToast('Erro ao carregar comparação de serviços');
      }
    }

    buildMonthOptions();
    fetchBreakdown();
    sel.addEventListener('change', fetchBreakdown);

    cmpSwitch.addEventListener('change', function(){
      const enabled = cmpSwitch.checked;
      cmpCol.style.display = enabled ? '' : 'none';
      cmpSel.style.display = enabled ? '' : 'none';
      if (enabled && !donutCmp){
        donutCmp = new ApexCharts(elCmp, {
          chart: { type: 'donut', background: 'transparent' },
          theme: { mode: 'dark', palette: 'palette1' },
          dataLabels: { enabled: false },
          legend: { position: 'bottom' },
          plotOptions: { pie: { donut: { labels: { show: true, name: { fontSize: '22px', fontWeight: 600 }, value: { fontSize: '16px', fontWeight: 400, formatter: function(v){ return `${parseInt(v||0)} concl.`; } } } } } },
          tooltip: { y: { formatter: function(v){ return `${parseInt(v||0)} concl.`; } } },
          labels: [],
          series: []
        });
        donutCmp.render();
        fetchBreakdownCmp();
      }
    });

    cmpSel.addEventListener('change', fetchBreakdownCmp);
  })();

  (function(){
    const el = document.querySelector('#bsb-chart-7');
    const sel = document.getElementById('barberRangeSelect');
    const listEl = document.getElementById('barberSideList');
    if (!el || !sel || !listEl) return;

    const chart = new ApexCharts(el, {
      chart: { type: 'bar', height: 320, background: 'transparent', toolbar: { show: false } },
      theme: { mode: 'dark' },
      grid: { borderColor: 'transparent' },
      plotOptions: { bar: { horizontal: true, borderRadius: 4, barHeight: '60%', distributed: true } },
      colors: ['#00E396', '#FEB019', '#FF4560', '#775DD0', '#3F51B5', '#546E7A', '#26A69A', '#D10CE8', '#E91E63', '#29B6F6'],
      dataLabels: { enabled: true, formatter: function(val){ return `${parseInt(val||0)} concl.`; } },
      xaxis: { categories: [], labels: { style: { colors: ['#a1aab2'] } } },
      yaxis: { labels: { style: { colors: ['#a1aab2'] } } },
      tooltip: { y: { formatter: function(val){ return `${parseInt(val||0)} concl.`; } } },
      legend: { show: false },
      series: [{ name: 'Concluídos', data: [] }]
    });
    chart.render();

    function buildRangeOptions(){
      const now = new Date();
      const currentMonthVal = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      const opts = [
        { val: `month:${currentMonthVal}`, label: 'Mês atual' },
        { val: 'range:30', label: 'Últ. 1 mês' },
        { val: 'range:15', label: 'Últ. 15 dias' },
        { val: 'range:7', label: 'Últ. 7 dias' },
        { val: 'range:today', label: 'Hoje' },
      ];
      sel.innerHTML = '';
      opts.forEach(o => { const op = document.createElement('option'); op.value = o.val; op.textContent = o.label; sel.appendChild(op); });
      sel.value = opts[0].val;
    }

    function renderBarberList(barbers, colors){
      listEl.innerHTML = '';
      const col = document.createElement('div');
      col.className = 'd-flex flex-column gap-2';
      (barbers || []).forEach((b, i) => {
        const item = document.createElement('div');
        item.className = 'd-inline-flex align-items-center justify-content-between gap-2';
        const img = document.createElement('img');
        img.src = b.avatar_url || '/static/assets/img/icon-logo.png';
        img.alt = b.name || 'Barbeiro';
        img.width = 28; img.height = 28; img.style.borderRadius = '50%'; img.style.objectFit = 'cover';
        const colorDot = document.createElement('span');
        colorDot.style.display = 'inline-block';
        colorDot.style.width = '10px';
        colorDot.style.height = '10px';
        colorDot.style.borderRadius = '50%';
        colorDot.style.backgroundColor = (colors && colors[i % colors.length]) || '#0090FF';
        const name = document.createElement('span');
        name.textContent = b.name || 'Barbeiro';
        name.className = 'text-light';
        const left = document.createElement('div');
        left.className = 'd-inline-flex align-items-center gap-2';
        left.appendChild(colorDot);
        left.appendChild(img);
        left.appendChild(name);
        const count = document.createElement('span');
        count.textContent = `${parseInt(b.count || 0)} concl.`;
        count.className = 'text-secondary';
        item.appendChild(left);
        item.appendChild(count);
        col.appendChild(item);
      });
      listEl.appendChild(col);
    }

    async function fetchBarberStats(){
      const selected = sel.value || '';
      let range = '';
      let month = '';
      if (selected.startsWith('month:')) {
        month = selected.split(':')[1] || '';
      } else if (selected.startsWith('range:')) {
        range = selected.split(':')[1] || '';
      }
      try{
        const qs = new URLSearchParams();
        if (range) qs.set('range', range);
        if (month) qs.set('month', month);
        const res = await fetch(`/painel/financas/barber-stats-data/?${qs.toString()}`, { credentials: 'same-origin' });
        if(!res.ok) throw new Error('Falha ao obter dados de barbeiros');
        const json = await res.json();
        const labels = json.labels || [];
        const seriesData = (json.series || []).map(v => parseInt(v||0));
        const barbers = json.barbers || []; // expect {name, avatar_url, count}

        chart.updateOptions({ xaxis: { categories: labels } });
        chart.updateSeries([{ name: 'Concluídos', data: seriesData }]);
        
        // Render side list
        renderBarberList(barbers, ['#00E396', '#FEB019', '#FF4560', '#775DD0', '#3F51B5', '#546E7A', '#26A69A', '#D10CE8', '#E91E63', '#29B6F6']);
      }catch(e){ 
        console.error(e);
        showToast('Erro ao carregar estatísticas por barbeiro');
      }
    }

    buildRangeOptions();
    fetchBarberStats();
    sel.addEventListener('change', fetchBarberStats);
  })();
</script>
{% endblock %}
