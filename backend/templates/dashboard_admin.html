{% extends 'base.html' %}
{% block title %}Painel Administrativo{% endblock %}
{% block content %}
<div class="d-flex justify-content-end align-items-center mb-2 gap-2 flex-wrap">
  <a href="#" class="btn btn-sm btn-accent d-inline-flex align-items-center" data-bs-toggle="modal" data-bs-target="#quickScheduleModal">Novo agendamento</a>
  <a href="#" class="btn btn-sm btn-outline-light d-inline-flex align-items-center" data-bs-toggle="modal" data-bs-target="#newSaleModal">Nova venda</a>
  <button class="btn btn-sm btn-accent d-inline-flex align-items-center" id="kpiToggleAdmin" type="button" data-bs-toggle="collapse" data-bs-target="#kpiCollapseAdmin" aria-expanded="true" aria-controls="kpiCollapseAdmin">
    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" class="me-1"><path d="M7 10l5 5 5-5z"></path></svg>
    <span class="kpi-toggle-label">Ocultar</span>
  </button>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      var el = document.getElementById('kpiCollapseAdmin');
      var btn = document.getElementById('kpiToggleAdmin');
      if (!el || !btn || !window.bootstrap) return;
      var inst = window.bootstrap.Collapse.getOrCreateInstance(el, { toggle: false });
      var label = btn.querySelector('.kpi-toggle-label');
      function syncLabel(){ var opened = el.classList.contains('show'); if(label){ label.textContent = opened ? 'Ocultar' : 'Mostrar'; } }
      if (window.innerWidth < 992) { inst.hide(); btn.setAttribute('aria-expanded', 'false'); syncLabel(); }
      btn.addEventListener('click', function(){
        var opened = el.classList.contains('show');
        if (opened) { inst.hide(); btn.setAttribute('aria-expanded', 'false'); }
        else { inst.show(); btn.setAttribute('aria-expanded', 'true'); }
      });
      el.addEventListener('shown.bs.collapse', syncLabel);
      el.addEventListener('hidden.bs.collapse', syncLabel);
    });
  </script>
</div>
<div class="collapse show" id="kpiCollapseAdmin">
<div class="row g-3 mb-4">
  <div class="col-sm-6 col-lg-3">
    <div class="card card-panel">
      <div class="card-body">
        <div class="kpi">{{ kpis.barbers_count }}</div>
        <div class="kpi-label">Barbeiros</div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card card-panel">
      <div class="card-body">
        <div class="kpi">{{ kpis.appointments_count }}</div>
        <div class="kpi-label">Agendamentos Hoje</div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card card-panel">
      <div class="card-body">
        <div class="kpi">{{ kpis.sales_count }}</div>
        <div class="kpi-label">Vendas Hoje</div>
      </div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="card card-panel">
      <div class="card-body">
        <div class="kpi">R$ {{ kpis.sales_total }}</div>
        <div class="kpi-label">Faturamento do Dia</div>
      </div>
    </div>
  </div>
</div>
</div>

<div class="row g-3">
  <div class="col-lg-6">
    <div class="card card-panel mb-4">
      <div class="card-header fw-semibold">Status dos agendamentos de hoje</div>
      <div class="card-body">
        {% if status_breakdown %}
          <div class="d-flex flex-wrap gap-2">
            {% for item in status_breakdown %}
              {% if item.status == 'scheduled' %}
                <span class="badge rounded-pill text-bg-secondary">Agendado: {{ item.c }}</span>
              {% elif item.status == 'done' %}
                <span class="badge rounded-pill bg-success">Concluído: {{ item.c }}</span>
              {% elif item.status == 'cancelled' %}
                <span class="badge rounded-pill bg-danger">Cancelado: {{ item.c }}</span>
              {% elif item.status == 'no_show' %}
                <span class="badge rounded-pill bg-warning text-dark">Faltou: {{ item.c }}</span>
              {% else %}
                <span class="badge rounded-pill badge-accent">{{ item.status }}: {{ item.c }}</span>
              {% endif %}
            {% endfor %}
          </div>
        {% else %}
          <div class="muted">Sem agendamentos hoje.</div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card card-panel mb-4">
      <div class="card-header d-flex justify-content-center align-items-center">
        <span class="fw-semibold text-center">Agendamentos recentes</span>
      </div>
      <div id="adminApptsBody" class="collapse show card-body p-0">
        <style>
          @media (max-width: 576px){
            #adminApptsTable thead{display:none}
            #adminApptsTable tbody tr{display:block;margin:10px;border:1px solid #2a2a2d;border-radius:12px;overflow:hidden}
            #adminApptsTable tbody td{display:flex;justify-content:space-between;gap:10px;padding:10px 12px;border:0;border-top:1px solid #2a2a2d;word-break:break-word}
            #adminApptsTable tbody td:first-child{border-top:0}
            #adminApptsTable tbody tr td:nth-child(7){display:none}
          }
          .row-status-done{background-color:rgba(23,62,43,0.35);border-color:#226b4a}
          .row-status-scheduled{background-color:rgba(255,193,7,0.18);border-color:#9d7b00}
          .row-status-cancelled{background-color:rgba(58,29,29,0.35);border-color:#6b2222}
          .row-status-unknown{background-color:rgba(60,60,60,0.2)}
          .cell-status-done{background-color:rgba(23,62,43,0.35)}
          .cell-status-scheduled{background-color:rgba(255,193,7,0.18)}
          .cell-status-cancelled{background-color:rgba(58,29,29,0.35)}
          .cell-status-unknown{background-color:rgba(60,60,60,0.2)}
          .status-pill{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;font-size:12px;background:rgba(255,255,255,0.06)}
        </style>
        <table id="adminApptsTable" class="table table-dark table-striped mb-0">
          <thead>
            <tr>
              <th style="width: 80px;">Hora</th>
              <th>Barbeiro</th>
              <th>Cliente</th>
              <th>Telefone</th>
              <th>Serviço</th>
              <th style="width: 140px;">Agendado em</th>
            </tr>
          </thead>
          <tbody>
            {% for a in appointments_today %}
            <tr class="{% if a.status == 'done' %}row-status-done{% elif a.status == 'scheduled' %}row-status-scheduled{% elif a.status == 'cancelled' %}row-status-cancelled{% else %}row-status-unknown{% endif %}">
              <td class="{% if a.status == 'done' %}cell-status-done{% elif a.status == 'scheduled' %}cell-status-scheduled{% elif a.status == 'cancelled' %}cell-status-cancelled{% else %}cell-status-unknown{% endif %}">{{ a.start_datetime|date:'H:i' }} <span class="status-pill">{% if a.status == 'scheduled' %}Em andamento{% elif a.status == 'done' %}Concluído{% elif a.status == 'cancelled' %}Cancelado{% else %}{{ a.status }}{% endif %}</span></td>
              <td>
                {% if a.barber.avatar %}
                  <img src="{{ a.barber.avatar.url }}" alt="avatar" class="rounded-circle me-2" style="width:24px;height:24px;object-fit:cover;">
                {% endif %}
                {{ a.barber.display_name|default:a.barber.username }}
              </td>
              <td>{{ a.client_name }}</td>
              <td>
                {{ a.client_phone }}
                {% if a.client_phone %}
                  <a href="https://wa.me/{{ a.client_phone }}" target="_blank" class="ms-2" title="WhatsApp">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20.52 3.48A11.78 11.78 0 0 0 3.47 20.52L2 22l1.56-.41A11.78 11.78 0 0 0 12 23.78 11.78 11.78 0 0 0 23.78 12 11.76 11.76 0 0 0 20.52 3.48zm-8.5 18.2a9.96 9.96 0 0 1-5.08-1.39l-.36-.21-3 .78.8-2.94-.23-.38a10 10 0 1 1 18.36-5.07 10 10 0 0 1-10.49 9.21zm5.71-7.53c-.31-.16-1.81-.89-2.09-.99s-.48-.15-.68.16-.78.99-.95 1.2-.35.23-.66.08a8.2 8.2 0 0 1-2.41-1.49 9.09 9.09 0 0 1-1.64-2.03c-.17-.31 0-.48.13-.64s.31-.38.46-.58.21-.31.32-.52.05-.39-.02-.55-.68-1.64-.93-2.24-.49-.52-.67-.53h-.57a1.1 1.1 0 0 0-.79.37 3.34 3.34 0 0 0-1.05 2.49 5.8 5.8 0 0 0 1.24 3.08 13.2 13.2 0 0 0 5.06 4.34c.72.31 1.43.6 2.18.77a5 5 0 0 0 2.28.14 3.72 3.72 0 0 0 2.44-1.72 3 3 0 0 0 .2-1.79c-.09-.16-.28-.23-.59-.38z"/></svg>
                  </a>
                {% endif %}
              </td>
              <td>
                {% with bname=a.barber.display_name|default:a.barber.username %}
                  {{ bname }} — {{ a.service.title }}
                {% endwith %}
                {% for s in a.sale_set.all %}
                  {% if s.service and s.status == 'paid' %}
                    + {{ s.service.title }}
                  {% endif %}
                {% endfor %}
              </td>
              <td>{{ a.created_at|date:'d/m H:i' }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center muted">Sem registros.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Aviso removido conforme solicitação -->
{% endblock %}
