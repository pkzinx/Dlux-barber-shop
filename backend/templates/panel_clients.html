{% extends 'base.html' %}
{% block title %}Clientes{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0 d-none d-md-block">Clientes</h3>
  <div class="d-flex align-items-center gap-2 flex-wrap">
    {% if user.role == 'admin' or user.username|lower == 'kaue' or user.username|lower == 'alafy' %}
    <div class="btn-group">
      <a href="?export=all" class="btn btn-sm btn-accent">Baixar CSV (Tudo)</a>
      <a href="?export=name_phone" class="btn btn-sm btn-outline-light">Nome + Telefone</a>
      <a href="?export=phone" class="btn btn-sm btn-outline-light">Somente Telefone</a>
    </div>
    <div style="min-width:200px">
      <select id="sortSelect" class="form-select form-select-sm bg-dark text-light border-secondary">
        <option value="">Ordena√ß√£o padr√£o</option>
        <option value="a_z" {% if sort == 'a_z' %}selected{% endif %}>A-Z (nome)</option>
        <option value="most_visits" {% if sort == 'most_visits' %}selected{% endif %}>Mais visitas conclu√≠das</option>
        <option value="last_appointment" {% if sort == 'last_appointment' %}selected{% endif %}>√öltimo agendamento (maior tempo sem visitar)</option>
        <option value="total_spent" {% if sort == 'total_spent' %}selected{% endif %}>Total gasto</option>
      </select>
    </div>
    {% endif %}
  </div>
  </div>

<style>
.client-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem}
.client-card{background:#151516;border:1px solid #2a2a2d;border-radius:12px;overflow:hidden}
.client-toggle{display:block;width:100%;text-align:left;background:transparent;border:0;padding:14px}
.client-header{display:flex;align-items:center;justify-content:space-between;gap:10px}
.client-title{font-weight:600;color:#ffffff}
.client-phone{color:#c59d5f}
.client-meta{display:flex;align-items:center;gap:10px;margin-top:8px;color:#bdbdbd}
.client-body{background:#0f0f12;border-top:1px solid #2a2a2d;padding:14px}
</style>

<script>
function onSortChange(sel){
  var v = sel && sel.value ? sel.value : '';
  var url = new URL(window.location.href);
  if(v){ url.searchParams.set('sort', v); } else { url.searchParams.delete('sort'); }
  url.searchParams.delete('export');
  window.location.href = url.toString();
}
document.addEventListener('DOMContentLoaded', function(){
  var sel = document.getElementById('sortSelect');
  if(sel){ sel.addEventListener('change', function(){ onSortChange(sel); }); }
  var sends = document.querySelectorAll('.msg-send');
  sends.forEach(function(btn){
    btn.addEventListener('click', function(e){
      e.preventDefault();
      var cid = btn.getAttribute('data-cid');
      var phone = (btn.getAttribute('data-phone') || '').replace(/\D/g,'');
      var s = document.getElementById('msgSelect'+cid);
      if(!s){ return; }
      var opt = s.selectedOptions && s.selectedOptions[0];
      var msg = opt ? (opt.dataset.msg || opt.text || '') : '';
      if(!msg){ return; }
      var url = 'https://wa.me/' + phone + '?text=' + encodeURIComponent(msg);
      window.open(url, '_blank');
    });
  });
});
</script>

<div class="client-grid">
  {% for c in clients %}
  {% with cid=forloop.counter %}
  <div class="client-card">
    <button class="client-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#clientBody{{ cid }}" aria-expanded="{% if sort == 'last_appointment' %}true{% else %}false{% endif %}" aria-controls="clientBody{{ cid }}">
      <div class="client-header">
        <div class="client-title">{{ c.name|default:"Cliente" }}</div>
        <div class="client-phone d-inline-flex align-items-center gap-2">
          <span>{{ c.phone }}</span>
          <a href="https://wa.me/{{ c.phone }}" target="_blank" rel="noopener" title="Abrir WhatsApp" class="text-success d-inline-flex align-items-center" style="line-height:0">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M20.52 3.48A11.84 11.84 0 0 0 12.04.01C5.74.01.6 5.11.6 11.38c0 2.02.53 4 1.54 5.75L.03 24l6.98-2.07a11.7 11.7 0 0 0 5.03 1.14h.01c6.3 0 11.44-5.1 11.44-11.38 0-3.04-1.21-5.9-3.46-8.21ZM12.04 21.1h-.01c-1.6 0-3.17-.42-4.54-1.22l-.33-.19-4.14 1.23 1.19-4.04-.22-.35a9.37 9.37 0 0 1-1.44-5.05c0-5.14 4.22-9.32 9.43-9.32 2.52 0 4.89.97 6.67 2.75 1.78 1.77 2.76 4.12 2.76 6.61 0 5.14-4.22 9.32-9.37 9.32Zm5.31-7.03c-.29-.15-1.7-.83-1.96-.92-.26-.1-.45-.15-.64.15-.18.29-.74.92-.9 1.11-.17.19-.33.22-.61.08-.29-.15-1.22-.45-2.33-1.44-.86-.77-1.44-1.72-1.61-2.01-.17-.29-.02-.45.13-.6.13-.13.29-.34.43-.52.15-.17.2-.29.29-.48.1-.19.05-.36-.02-.51-.07-.15-.64-1.55-.88-2.14-.23-.56-.47-.48-.64-.48h-.55c-.19 0-.51.08-.77.36-.26.29-1 1-1 2.43 0 1.43 1.02 2.82 1.16 3.02.15.19 2 3.05 4.85 4.17.68.3 1.21.48 1.62.61.68.22 1.3.19 1.79.11.55-.08 1.7-.69 1.94-1.36.24-.67.24-1.24.17-1.36-.07-.13-.26-.2-.55-.35Z"></path>
            </svg>
          </a>
        </div>
      </div>
      <div class="client-meta">
        <span>Visitas conclu√≠das: {{ c.count_done }}</span>
      </div>
    </button>
    <div id="clientBody{{ cid }}" class="collapse {% if sort == 'last_appointment' %}show{% endif %}">
      <div class="client-body">
        <div>√öltima visita: {% if c.last_visit %}{{ c.last_visit|date:"d/m/Y H:i" }}{% else %}‚Äî{% endif %}</div>
        <div>Total gasto: R$ {{ c.total_spent }}</div>
        {% if c.freq_label %}
        <div>Frequ√™ncia m√©dia: {{ c.freq_label }}</div>
        {% endif %}
        {% if sort == 'last_appointment' %}
        <div class="mt-3">
          <label for="msgSelect{{ cid }}" class="form-label">Mensagens prontas</label>
          <select id="msgSelect{{ cid }}" class="form-select form-select-sm bg-dark text-light border-secondary msg-select" data-cid="{{ cid }}">
            <option value="">Selecione uma mensagem‚Ä¶</option>
            <optgroup label="Manuten√ß√£o üëá">
              <option data-msg='Fala tudo certo?&#10;&#10;Passando pra lembrar que a manuten√ß√£o √© o segredo de um visual sempre alinhado. Bora renovar o corte e a barba pra essa semana?&#10;&#10;Garanta seu hor√°rio aqui: `https://dluxbarbearia.shop/#servicos` '>Fala tudo certo?

Passando pra lembrar que a manuten√ß√£o √© o segredo de um visual sempre alinhado. Bora renovar o corte e a barba pra essa semana?

Garanta seu hor√°rio aqui: `https://dluxbarbearia.shop/#servicos` </option>
              <option data-msg='E a√≠, beleza?&#10;&#10;Faz um tempinho que n√£o te vemos na cadeira! Que tal dar aquele trato no visual hoje? A equipe t√° pronta te esperando.&#10;&#10;Clica pra escolher o hor√°rio: `https://dluxbarbearia.shop/#servicos` '>E a√≠, beleza?

Faz um tempinho que n√£o te vemos na cadeira! Que tal dar aquele trato no visual hoje? A equipe t√° pronta te esperando.

Clica pra escolher o hor√°rio: `https://dluxbarbearia.shop/#servicos` </option>
            </optgroup>
            <optgroup label="Resgate e transforma√ß√£o üëá">
              <option data-msg='Ol√°. Sabe aquela confian√ßa de quando voc√™ acabou de sair da barbearia?&#10;&#10;T√° na hora de recuperar ela! A cadeira t√° pronta e a tesoura afiada te esperando.&#10;&#10;Vamos renovar? Agende aqui: `https://dluxbarbearia.shop/#servicos` '>Ol√°. Sabe aquela confian√ßa de quando voc√™ acabou de sair da barbearia?

T√° na hora de recuperar ela! A cadeira t√° pronta e a tesoura afiada te esperando.

Vamos renovar? Agende aqui: `https://dluxbarbearia.shop/#servicos` </option>
              <option data-msg='Boa! Passando pra avisar que liberamos alguns hor√°rios extras essa semana.&#10;&#10;O momento ideal pra tirar esse peso do visual e ficar na r√©gua. N√£o deixa pra depois!&#10;&#10;Link direto da agenda: `https://dluxbarbearia.shop/#servicos` '>Boa! Passando pra avisar que liberamos alguns hor√°rios extras essa semana.

O momento ideal pra tirar esse peso do visual e ficar na r√©gua. N√£o deixa pra depois!

Link direto da agenda: `https://dluxbarbearia.shop/#servicos` </option>
            </optgroup>
            <optgroup label="Recupera√ß√£o e Reconquista üëá">
              <option data-msg='Fala! A gente sabe que a vida √© corrida, mas sentimos sua falta por aqui.&#10;&#10;Queremos voc√™ de volta no time! Liberei um desconto exclusivo (ou uma Cerveja Gr√°tis) pro seu retorno essa semana.&#10;&#10;O padr√£o D-Lux que voc√™ conhece, com um incentivo extra. Agende agora: `https://dluxbarbearia.shop/#servicos` '>Fala! A gente sabe que a vida √© corrida, mas sentimos sua falta por aqui.

Queremos voc√™ de volta no time! Liberei um desconto exclusivo (ou uma Cerveja Gr√°tis) pro seu retorno essa semana.

O padr√£o D-Lux que voc√™ conhece, com um incentivo extra. Agende agora: `https://dluxbarbearia.shop/#servicos` </option>
              <option data-msg='vou ser transparente.&#10;Faz um tempo que voc√™ n√£o corta com a gente, ent√£o liberamos uma condi√ß√£o especial pra voc√™ voltar.&#10;Se animar, √© s√≥ responder essa mensagem'>vou ser transparente.
Faz um tempo que voc√™ n√£o corta com a gente, ent√£o liberamos uma condi√ß√£o especial pra voc√™ voltar.
Se animar, √© s√≥ responder essa mensagem</option>
            </optgroup>
            <optgroup label="Engra√ßado e descontra√≠do üëá">
              <option data-msg='Opa! O espelho j√° te avisou ou vou ter que avisar?&#10;&#10;O visual t√° pedindo socorro! N√£o deixa a situa√ß√£o ficar cr√≠tica.&#10;&#10;Bora resolver isso hoje? Clica aqui: `https://dluxbarbearia.shop/#servicos` '>Opa! O espelho j√° te avisou ou vou ter que avisar?

O visual t√° pedindo socorro! N√£o deixa a situa√ß√£o ficar cr√≠tica.

Bora resolver isso hoje? Clica aqui: `https://dluxbarbearia.shop/#servicos` </option>
            </optgroup>
          </select>
          <div class="mt-2 d-flex gap-2">
            <a href="#" class="btn btn-sm btn-success msg-send" data-cid="{{ cid }}" data-phone="{{ c.phone }}">Enviar no WhatsApp</a>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endwith %}
  {% empty %}
  <div class="text-center text-muted">Sem clientes cadastrados.</div>
  {% endfor %}
</div>
{% endblock %}
